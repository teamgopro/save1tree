<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TEKA Trees</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6f4ea;
      margin: 0;
      padding: 30px;
      color: #065f46;
      display: flex;
      gap: 40px;
    }
    .left, .right {
      flex: 1;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    #counter {
      font-size: 3rem;
      font-weight: bold;
    }
    #facts {
      margin: 20px 0;
      font-style: italic;
      max-width: 500px;
    }
    #plantForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #a7f3d0;
    }
    #plantBtn {
      background: #10b981;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #plantBtn:hover {
      background: #059669;
    }
    #treeEmoji {
      font-size: 3rem;
      margin: 20px 0;
    }
    .tree-bounce {
      animation: bounce 0.5s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    #leaderboard li {
      background: #d1fae5;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      max-width: 400px;
    }
    .medal {
      font-weight: bold;
      margin-right: 5px;
    }
    #goalContainer {
      margin-top: 30px;
      width: 100%;
      max-width: 400px;
    }
    #progressBar {
      height: 20px;
      background: #d1fae5;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 5px;
    }
    #progressFill {
      height: 100%;
      background: #10b981;
      width: 0%;
      transition: width 0.5s ease;
    }
    #donateContainer {
      margin-top: 30px;
    }
    #dedications {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid #b0eacd;
      padding: 15px;
      border-radius: 12px;
      max-height: 300px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.95rem;
      transition: all 0.5s ease;
    }
    .dedication {
      animation: fadein 0.6s ease-in-out;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="left">
    <h1>TEKA Trees</h1>
    <div id="counter">0</div>
    <div id="facts"></div>
    <form id="plantForm">
      <input type="text" id="nameInput" placeholder="Enter your name" />
      <input type="text" id="dedicationInput" placeholder="Dedication (optional)" />
      <button type="submit" id="plantBtn">🌱 Plant Tree</button>
    </form>
    <div id="treeEmoji">🌳</div>

    <div id="goalContainer">
      <h2>Global Goal: 100 Million Trees</h2>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>

    <h2>Leaderboard</h2>
    <ul id="leaderboard"></ul>

    <div id="donateContainer">
      <h2>Support Our Mission</h2>
      <p>Donate to plant trees – every $1 = 100 🌳</p>
      <div id="paypal-donate-button-container"></div>
    </div>
  </div>

  <div class="right">
    <h2>🌿 Recent Dedications</h2>
    <div id="dedications"></div>
  </div>

  <!-- Firebase + PayPal -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.paypalobjects.com/donate/sdk/donate-sdk.js" charset="UTF-8"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const counterEl = document.getElementById("counter");
    const leaderboardEl = document.getElementById("leaderboard");
    const factsEl = document.getElementById("facts");
    const dedicationEl = document.getElementById("dedications");
    const progressFill = document.getElementById("progressFill");
    const treeEmoji = document.getElementById("treeEmoji");

    const cooldowns = {};

    const facts = [
      "Trees absorb harmful gases and give us clean oxygen.",
      "One tree can remove up to 48 pounds of CO2 per year.",
      "Urban forests can reduce city temperatures by up to 10°F.",
      "Trees are home to more than 80% of land-based species.",
      "Planting trees can reduce stress and improve mood."
    ];
    let factIndex = 0;
    function rotateFacts() {
      factsEl.textContent = facts[factIndex];
      factIndex = (factIndex + 1) % facts.length;
    }
    rotateFacts();
    setInterval(rotateFacts, 7000);

    function getTodayKey() {
      return new Date().toISOString().split("T")[0];
    }

    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 500);
    }

    function updateLeaderboard(users) {
      leaderboardEl.innerHTML = "";
      const today = getTodayKey();
      const entries = Object.entries(users).map(([user, days]) => [user, days[today] || 0]);
      entries.sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([user, count], index) => {
        const li = document.createElement("li");
        const medals = ["🥇", "🥈", "🥉"];
        li.innerHTML = `<span class="medal">${medals[index] || ""}</span> ${user}: ${count} tree${count !== 1 ? "s" : ""}`;
        leaderboardEl.appendChild(li);
      });
    }

    function updateGlobalProgress(total) {
      const percent = Math.min(100, (total / 100000000) * 100);
      progressFill.style.width = `${percent}%`;
    }

    function updateDedications(snapshot) {
      dedicationEl.innerHTML = "";
      const list = [];
      snapshot.forEach(child => list.push(child.val()));
      list.slice(-5).forEach(d => {
        const div = document.createElement("div");
        div.className = "dedication";
        div.textContent = `${d.user || "Anonymous"}: “${d.message}”`;
        dedicationEl.appendChild(div);
      });
    }

    document.getElementById("plantForm").addEventListener("submit", e => {
      e.preventDefault();
      const nameInput = document.getElementById("nameInput");
      const dedication = document.getElementById("dedicationInput").value.trim();
      const name = nameInput.value.trim() || "Name not entered";

      const now = Date.now();
      if (cooldowns[name] && now - cooldowns[name] < 5000) {
        alert("🌱 Please wait 5 seconds before planting again.");
        return;
      }
      cooldowns[name] = now;

      const today = getTodayKey();
      db.ref(`treeCount/${today}`).transaction(n => (n || 0) + 1);
      db.ref(`users/${name}/${today}`).transaction(n => (n || 0) + 1);
      if (dedication) {
        db.ref(`dedications/${today}`).push({ user: name, message: dedication });
      }
      animateTree();
    });

    db.ref("users").on("value", snap => updateLeaderboard(snap.val() || {}));
    db.ref(`treeCount/${getTodayKey()}`).on("value", snap => {
      counterEl.textContent = snap.val() || 0;
    });
    db.ref("treeCount").on("value", snap => {
      let total = 0;
      snap.forEach(child => total += child.val() || 0);
      updateGlobalProgress(total);
    });
    db.ref(`dedications/${getTodayKey()}`).on("value", updateDedications);

    function addDonationTrees(numTrees) {
      const today = getTodayKey();
      db.ref(`treeCount/${today}`).transaction(n => (n || 0) + numTrees);
    }

    PayPal.Donation.Button({
      env: 'production', // change to 'sandbox' for testing
      hosted_button_id: 'BVWWLMB3DZXW4',
      image: {
        src: 'https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif',
        alt: 'Donate with PayPal button'
      },
      onComplete: donation => {
        const dollars = parseFloat(donation.amt);
        if (!isNaN(dollars) && dollars > 0) {
          const trees = Math.round(dollars * 100);
          addDonationTrees(trees);
          alert(`🌲 ${trees} trees planted from your donation. Thank you!`);
        }
      }
    }).render('#paypal-donate-button-container');
  </script>
</body>
</html>
