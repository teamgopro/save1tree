<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees - Old Style</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #e0f7fa;
      color: #004d40;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      font-weight: 700;
      color: #004d40;
    }
    #counter {
      font-size: 4rem;
      text-align: center;
      font-weight: 900;
    }
    #facts {
      text-align: center;
      font-style: italic;
      margin: 10px auto 25px;
      max-width: 500px;
      color: #00695c;
    }
    #progressBarContainer, #dailyProgressBarContainer {
      background: #b2dfdb;
      border-radius: 15px;
      margin: 0 auto 20px;
      box-shadow: inset 0 0 6px #004d40aa;
      width: 80%;
      max-width: 400px;
    }
    #progressBar, #dailyProgressBar {
      height: 22px;
      width: 0;
      border-radius: 15px;
      transition: width 0.4s ease;
      box-shadow: 0 0 8px #00796b;
    }
    #progressBar {
      background: linear-gradient(90deg, #00bfa5, #004d40);
    }
    #dailyProgressBar {
      background: linear-gradient(90deg, #004d40, #00bfa5);
    }
    #plantForm {
      display: none; /* only show after login */
      justify-content: center;
      gap: 10px;
      max-width: 400px;
      margin: auto;
    }
    #nameInput, #dedicationInput, #plantBtn {
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
    }
    #nameInput {
      flex-grow: 1;
      border: 2px solid #004d40;
      color: #004d40;
    }
    #dedicationInput {
      flex-grow: 1;
      border: 2px solid #004d40;
      color: #004d40;
      font-style: italic;
    }
    #plantBtn {
      background: #00796b;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      min-width: 120px;
    }
    #treeEmoji {
      text-align: center;
      font-size: 3.5rem;
    }
    .tree-bounce {
      animation: bounce 0.7s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      max-width: 400px;
      margin: auto;
    }
    #leaderboard li {
      background: #b2dfdb;
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    #myStats, #challengeCountdown {
      text-align: center;
      font-weight: bold;
      color: #00796b;
    }
    #authContainer {
      max-width: 400px;
      margin: 0 auto 20px;
      text-align: center;
    }
    #authContainer input {
      padding: 8px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #004d40;
      font-size: 1rem;
    }
    #authContainer button {
      padding: 8px 16px;
      margin: 5px;
      border-radius: 6px;
      background-color: #00796b;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #authStatus {
      margin-top: 10px;
      color: #004d40;
      font-weight: 600;
    }
    #usernameContainer {
      display: none;
      margin-top: 10px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    #usernameContainer input {
      padding: 8px;
      width: 70%;
      border-radius: 6px;
      border: 1px solid #004d40;
      font-size: 1rem;
    }
    #usernameContainer button {
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #004d40;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-left: 6px;
    }
    #usernameStatus {
      margin-top: 5px;
      color: #00796b;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>TEKA Trees</h1>

  <div id="authContainer">
    <input type="email" id="emailInput" placeholder="Email" />
    <input type="password" id="passwordInput" placeholder="Password" />
    <br />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <div id="authStatus">Please log in to plant a tree.</div>
  </div>

  <div id="usernameContainer">
    <input type="text" id="usernameInput" placeholder="Choose a username" maxlength="20" />
    <button id="saveUsernameBtn">Save Username</button>
    <button id="changeUsernameBtn" style="display:none;">Change Username</button>
    <div id="usernameStatus"></div>
  </div>

  <div id="counter">0</div>
  <div id="facts"></div>

  <div id="progressBarContainer"><div id="progressBar"></div></div>

  <form id="plantForm">
    <input type="text" id="dedicationInput" placeholder="Dedicate your tree (optional)" maxlength="50" />
    <button type="submit" id="plantBtn">Plant a Tree ðŸŒ³</button>
  </form>

  <div id="treeEmoji">ðŸŒ³</div>
  <div id="myStats"></div>

  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>

  <div id="dailyChallenge">
    <strong>Daily Goal: Plant 50 Trees</strong>
    <div id="challengeCountdown">00:00:00</div>
    <div id="dailyProgressBarContainer"><div id="dailyProgressBar"></div></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const dailyGoal = 50;

    // Elements
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");

    const usernameContainer = document.getElementById("usernameContainer");
    const usernameInput = document.getElementById("usernameInput");
    const saveUsernameBtn = document.getElementById("saveUsernameBtn");
    const changeUsernameBtn = document.getElementById("changeUsernameBtn");
    const usernameStatus = document.getElementById("usernameStatus");

    const plantForm = document.getElementById("plantForm");
    const dedicationInput = document.getElementById("dedicationInput");
    const counterEl = document.getElementById("counter");
    const treeEmoji = document.getElementById("treeEmoji");
    const myStats = document.getElementById("myStats");
    const leaderboardEl = document.getElementById("leaderboard");
    const progressBar = document.getElementById("progressBar");
    const dailyProgressBar = document.getElementById("dailyProgressBar");

    let currentUsername = null;
    let cachedUsersData = {};

    // Helpers
    function getTodayKey() {
      return new Date().toISOString().split('T')[0];
    }

    // Animate tree emoji bounce
    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 700);
    }

    // Username uniqueness check (case-insensitive)
    async function isUsernameTaken(name) {
      const snapshot = await db.ref("users").once("value");
      const users = snapshot.val() || {};
      const lowerName = name.toLowerCase();

      return Object.values(users).some(user => user.username && user.username.toLowerCase() === lowerName);
    }

    // Load username for current user, show UI accordingly
    async function loadUsername(uid) {
      const snapshot = await db.ref(`users/${uid}/username`).once("value");
      currentUsername = snapshot.val();

      if (!currentUsername) {
        usernameContainer.style.display = "block";
        saveUsernameBtn.style.display = "inline";
        changeUsernameBtn.style.display = "none";
        usernameStatus.textContent = "Please set your username.";
        usernameInput.value = "";
      } else {
        usernameContainer.style.display = "block";
        saveUsernameBtn.style.display = "none";
        changeUsernameBtn.style.display = "inline";
        usernameStatus.textContent = `Your username: ${currentUsername}`;
        usernameInput.value = currentUsername;
      }
    }

    // Save or update username
    async function saveUsername() {
      const user = auth.currentUser;
      if (!user) return alert("Not logged in");

      const newUsername = usernameInput.value.trim();
      if (!newUsername) {
        usernameStatus.textContent = "Username cannot be empty.";
        return;
      }
      if (newUsername.length < 3) {
        usernameStatus.textContent = "Username must be at least 3 characters.";
        return;
      }

      if (newUsername === currentUsername) {
        usernameStatus.textContent = "This is already your username.";
        return;
      }

      // Check uniqueness
      const taken = await isUsernameTaken(newUsername);
      if (taken) {
        usernameStatus.textContent = "Username already taken. Try another.";
        return;
      }

      // Save username
      await db.ref(`users/${user.uid}/username`).set(newUsername);
      currentUsername = newUsername;
      usernameStatus.textContent = "Username saved!";
      saveUsernameBtn.style.display = "none";
      changeUsernameBtn.style.display = "inline";

      updateLeaderboardCached();
      updateStats(user.uid);
    }

    saveUsernameBtn.addEventListener("click", saveUsername);

    changeUsernameBtn.addEventListener("click", () => {
      usernameInput.value = currentUsername;
      usernameStatus.textContent = "Enter a new username and click Save.";
      saveUsernameBtn.style.display = "inline";
      changeUsernameBtn.style.display = "none";
    });

    // Update leaderboard UI from cachedUsersData
    function updateLeaderboardCached() {
      leaderboardEl.innerHTML = "";
      const today = getTodayKey();

      const entries = Object.entries(cachedUsersData).map(([uid, days]) => {
        const count = days[today] || 0;
        const username = days.username || null;
        return { uid, count, username };
      });

      entries.sort((a, b) => b.count - a.count);

      entries.slice(0, 10).forEach(({ uid, count, username }) => {
        const displayName = username || uid.substring(0, 6);
        const li = document.createElement("li");
        li.textContent = `${displayName}: ${count} tree${count !== 1 ? "s" : ""}`;
        leaderboardEl.appendChild(li);
      });
    }

    // Update leaderboard when users data changes
    function updateLeaderboard(users) {
      cachedUsersData = users || {};
      updateLeaderboardCached();
    }

    // Update stats UI for current user
    async function updateStats(uid) {
      const today = getTodayKey();
      const userRef = db.ref(`users/${uid}`);
      const [usernameSnap, countSnap] = await Promise.all([
        userRef.child("username").once("value"),
        userRef.child(today).once("value")
      ]);

      const username = usernameSnap.val() || uid.substring(0, 6);
      const count = countSnap.val() || 0;

      myStats.textContent = `You (${username}) have planted ${count} tree${count !== 1 ? 's' : ''}.`;
    }

    // Update total trees counter and progress bar (all time)
    function updateTotalCounter(users) {
      let totalTrees = 0;
      for (const userData of Object.values(users || {})) {
        if (userData) {
          for (const [key, val] of Object.entries(userData)) {
            if (key !== "username") {
              totalTrees += val;
            }
          }
        }
      }
      counterEl.textContent = totalTrees.toLocaleString();

      // Update overall progress bar (goal: 1000 trees)
      const maxGoal = 1000;
      const progress = Math.min(totalTrees / maxGoal, 1);
      progressBar.style.width = (progress * 100) + "%";
    }

    // Update daily challenge progress bar and countdown
    function updateDailyChallenge(users) {
      const today = getTodayKey();
      let dailyTotal = 0;
      for (const userData of Object.values(users || {})) {
        if (userData && userData[today]) {
          dailyTotal += userData[today];
        }
      }

      const progress = Math.min(dailyTotal / dailyGoal, 1);
      dailyProgressBar.style.width = (progress * 100) + "%";

      // Countdown to midnight UTC
      const now = new Date();
      const tomorrow = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1));
      const diff = tomorrow.getTime() - now.getTime();

      const hrs = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      const pad = n => n.toString().padStart(2, "0");
      document.getElementById("challengeCountdown").textContent = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
    }

    // Event handlers
    loginBtn.addEventListener("click", () => {
      auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value.trim())
        .catch(e => alert("Login failed: " + e.message));
    });

    registerBtn.addEventListener("click", () => {
      auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value.trim())
        .catch(e => alert("Registration failed: " + e.message));
    });

    logoutBtn.addEventListener("click", () => auth.signOut());

    plantForm.addEventListener("submit", async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("Please log in first.");
        return;
      }

      // Dedication text (optional)
      const dedication = dedicationInput.value.trim().slice(0, 50);
      const today = getTodayKey();

      // Increment today's count for user
      const userDayRef = db.ref(`users/${user.uid}/${today}`);
      const userDaySnapshot = await userDayRef.once("value");
      const currentCount = userDaySnapshot.val() || 0;

      // Update tree count and optional dedication message in the database
      // We store dedication under a separate path for display later if needed
      await userDayRef.set(currentCount + 1);

      if (dedication) {
        // Save dedication under a user-dedications node, with timestamp key for uniqueness
        const dedicationRef = db.ref(`dedications/${user.uid}/${Date.now()}`);
        await dedicationRef.set(dedication);
      }

      dedicationInput.value = "";

      animateTree();

      // Refresh leaderboard and stats
      // We fetch all user data again (could optimize by using Firebase listeners)
      const allUsersSnap = await db.ref("users").once("value");
      const usersData = allUsersSnap.val() || {};
      updateLeaderboard(usersData);
      updateStats(user.uid);
      updateTotalCounter(usersData);
      updateDailyChallenge(usersData);
    });

    // Firebase Auth listener
    auth.onAuthStateChanged(async user => {
      if (user) {
        authStatus.textContent = `Logged in as ${user.email}`;
        loginBtn.style.display = "none";
        registerBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        plantForm.style.display = "flex";

        await loadUsername(user.uid);

        // Initial data load
        const allUsersSnap = await db.ref("users").once("value");
        const usersData = allUsersSnap.val() || {};
        updateLeaderboard(usersData);
        updateTotalCounter(usersData);
        updateDailyChallenge(usersData);
        updateStats(user.uid);
      } else {
        authStatus.textContent = "Please log in to plant a tree.";
        loginBtn.style.display = "inline";
        registerBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        plantForm.style.display = "none";
        usernameContainer.style.display = "none";
        myStats.textContent = "";
        counterEl.textContent = "0";
        leaderboardEl.innerHTML = "";
        progressBar.style.width = "0%";
        dailyProgressBar.style.width = "0%";
        document.getElementById("challengeCountdown").textContent = "00:00:00";
      }
    });

    // Periodic update of daily countdown and progress every second
    setInterval(async () => {
      const allUsersSnap = await db.ref("users").once("value");
      const usersData = allUsersSnap.val() || {};
      updateDailyChallenge(usersData);
    }, 1000);
  </script>
</body>
</html>
