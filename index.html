<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees - Old Style</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #e0f7fa;
      color: #004d40;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      font-weight: 700;
      color: #004d40;
    }
    #counter {
      font-size: 4rem;
      text-align: center;
      font-weight: 900;
    }
    #facts {
      text-align: center;
      font-style: italic;
      margin: 10px auto 25px;
      max-width: 500px;
      color: #00695c;
    }
    #progressBarContainer, #dailyProgressBarContainer {
      background: #b2dfdb;
      border-radius: 15px;
      margin: 0 auto 20px;
      box-shadow: inset 0 0 6px #004d40aa;
      width: 80%;
      max-width: 400px;
    }
    #progressBar, #dailyProgressBar {
      height: 22px;
      width: 0;
      border-radius: 15px;
      transition: width 0.4s ease;
      box-shadow: 0 0 8px #00796b;
    }
    #progressBar {
      background: linear-gradient(90deg, #00bfa5, #004d40);
    }
    #dailyProgressBar {
      background: linear-gradient(90deg, #004d40, #00bfa5);
    }
    #authContainer {
      max-width: 400px;
      margin: 0 auto 20px;
      text-align: center;
    }
    #authContainer input {
      padding: 8px;
      margin: 5px;
      width: 180px;
      border-radius: 8px;
      border: 2px solid #004d40;
      color: #004d40;
      font-size: 1rem;
    }
    #authContainer button {
      padding: 8px 12px;
      margin: 5px;
      background: #00796b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    #authStatus {
      margin-top: 10px;
      color: #00796b;
      font-weight: bold;
    }
    #plantForm {
      display: none; /* Hidden until logged in */
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
      margin: auto;
      align-items: center;
    }
    #plantForm input[type="text"] {
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
      border: 2px solid #004d40;
      color: #004d40;
      width: 100%;
      box-sizing: border-box;
    }
    #plantBtn {
      background: #00796b;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.1rem;
    }
    #treeEmoji {
      text-align: center;
      font-size: 3.5rem;
      margin: 15px 0;
    }
    .tree-bounce {
      animation: bounce 0.7s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      max-width: 400px;
      margin: auto;
    }
    #leaderboard li {
      background: #b2dfdb;
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    #myStats, #challengeCountdown {
      text-align: center;
      font-weight: bold;
      color: #00796b;
    }
  </style>
</head>
<body>
  <h1>TEKA Trees</h1>

  <div id="authContainer">
    <input type="email" id="emailInput" placeholder="Email" />
    <input type="password" id="passwordInput" placeholder="Password" />
    <div>
      <button id="loginBtn">Login</button>
      <button id="registerBtn">Register</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
    <div id="authStatus">Please log in to plant a tree.</div>
  </div>

  <div id="counter">0</div>
  <div id="facts"></div>
  <div id="progressBarContainer"><div id="progressBar"></div></div>

  <form id="plantForm">
    <input type="text" id="dedicationInput" placeholder="Dedicate this tree (optional)" maxlength="100" />
    <button type="submit" id="plantBtn">Plant a Tree ðŸŒ³</button>
  </form>

  <div id="treeEmoji">ðŸŒ³</div>
  <div id="myStats">You have planted 0 trees.</div>

  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>

  <div id="dailyChallenge">
    <strong>Daily Goal: Plant 50 Trees</strong>
    <div id="challengeCountdown">00:00:00</div>
    <div id="dailyProgressBarContainer"><div id="dailyProgressBar"></div></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const dailyGoal = 50;

    const counterEl = document.getElementById("counter");
    const treeEmoji = document.getElementById("treeEmoji");
    const myStats = document.getElementById("myStats");
    const leaderboardEl = document.getElementById("leaderboard");
    const progressBar = document.getElementById("progressBar");
    const dailyProgressBar = document.getElementById("dailyProgressBar");

    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");
    const plantForm = document.getElementById("plantForm");
    const dedicationInput = document.getElementById("dedicationInput");

    function getTodayKey() {
      return new Date().toISOString().split('T')[0];
    }

    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 700);
    }

    function updateStats(uid) {
      const key = getTodayKey();
      db.ref(`users/${uid}/${key}`).once("value").then(snapshot => {
        const count = snapshot.val() || 0;
        myStats.textContent = `You have planted ${count} tree${count !== 1 ? 's' : ''}.`;
      });
    }

    function updateCountDisplay(count) {
      counterEl.textContent = count;
      const percent = Math.min((count / dailyGoal) * 100, 100);
      progressBar.style.width = percent + "%";
      dailyProgressBar.style.width = percent + "%";
    }

    function updateLeaderboard(users) {
      leaderboardEl.innerHTML = "";
      const today = getTodayKey();
      // We will need user emails for display, so let's fetch them:
      // users object structure: { uid: { date1: count, ... }, ... }
      // We'll also get user emails from a separate ref or from auth. For simplicity, show uid short here.
      const entries = Object.entries(users).map(([uid, days]) => [uid, days[today] || 0]);
      entries.sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([uid, count]) => {
        const li = document.createElement("li");
        li.textContent = `${uid.substring(0,6)}: ${count} tree${count !== 1 ? 's' : ''}`;
        leaderboardEl.appendChild(li);
      });
    }

    function startCountdown() {
      function update() {
        const now = new Date();
        const midnight = new Date(now);
        midnight.setHours(24, 0, 0, 0);
        const diff = midnight - now;
        const hrs = String(Math.floor(diff / (1000*60*60))).padStart(2, '0');
        const mins = String(Math.floor((diff % (1000*60*60)) / (1000*60))).padStart(2, '0');
        const secs = String(Math.floor((diff % (1000*60)) / 1000)).padStart(2, '0');
        document.getElementById("challengeCountdown").textContent = `${hrs}:${mins}:${secs}`;
      }
      update();
      setInterval(update, 1000);
    }

    function listenRealtime() {
      const today = getTodayKey();
      db.ref(`treeCount/${today}`).on("value", snap => {
        updateCountDisplay(snap.val() || 0);
      });
      db.ref("users").on("value", snap => {
        updateLeaderboard(snap.val() || {});
      });
    }

    loginBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) return alert("Enter email and password");
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => alert(error.message));
    });

    registerBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) return alert("Enter email and password");
      auth.createUserWithEmailAndPassword(email, password)
        .catch(error => alert(error.message));
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        authStatus.textContent = `Logged in as ${user.email}`;
        loginBtn.style.display = "none";
        registerBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        plantForm.style.display = "flex";
        updateStats(user.uid);
      } else {
        authStatus.textContent = "Please log in to plant a tree.";
        loginBtn.style.display = "inline";
        registerBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        plantForm.style.display = "none";
        myStats.textContent = "";
      }
    });

    plantForm.addEventListener("submit", e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("Please log in first.");
        return;
      }
      const dedication = dedicationInput.value.trim();
      const today = getTodayKey();

      db.ref(`treeCount/${today}`).transaction(n => (n || 0) + 1);
      db.ref(`users/${user.uid}/${today}`).transaction(n => (n || 0) + 1);
      if (dedication) {
        db.ref(`dedications/${user.uid}/${today}`).push(dedication);
      }
      animateTree();
      updateStats(user.uid);
      plantForm.reset();
    });

    const facts = [
      "Did you know? ðŸŒ³ Trees help reduce air pollution and provide oxygen for us to breathe.",
      "One large tree can supply oxygen for four people in a day.",
      "Trees absorb carbon dioxide, helping to fight climate change.",
      "Urban forests can cool cities by up to 10Â°F.",
      "Trees provide habitat for over 80% of the worldâ€™s terrestrial species."
    ];
    let factIndex = 0;
    function rotateFacts() {
      document.getElementById("facts").textContent = facts[factIndex];
      factIndex = (factIndex + 1) % facts.length;
    }
    rotateFacts();
    setInterval(rotateFacts, 7000);

    // Initialize realtime listeners and countdown
    listenRealtime();
    startCountdown();
  </script>
</body>
</html>
