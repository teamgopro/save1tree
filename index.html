<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees - Old Style</title>
  <style>
    /* ...[unchanged CSS styles]... */
  </style>
</head>
<body>
  <h1>TEKA Trees</h1>

  <div id="counter" aria-live="polite" aria-atomic="true">0</div>

  <div id="facts">
    Did you know? ðŸŒ³ Trees help reduce air pollution and provide oxygen for us to breathe.
  </div>

  <div id="progressBarContainer" aria-label="Progress towards daily tree planting goal">
    <div id="progressBar"></div>
  </div>

  <form id="plantForm" onsubmit="return false;">
    <input
      type="text"
      id="nameInput"
      placeholder="Enter your name"
      aria-label="Your name"
      required
      minlength="2"
      maxlength="20"
      autocomplete="off"
      spellcheck="false"
    />
    <button id="plantBtn" aria-label="Plant a tree">Plant a Tree ðŸŒ³</button>
  </form>

  <div id="treeEmoji" aria-hidden="true">ðŸŒ³</div>

  <div id="myStats" aria-live="polite" aria-atomic="true" role="status">You have planted 0 trees.</div>

  <h2>Leaderboard</h2>
  <ul id="leaderboard" role="list" aria-live="polite" aria-atomic="true"></ul>

  <div id="dailyChallenge" aria-label="Daily tree planting challenge">
    <strong>Daily Goal: Plant 50 Trees</strong>
    <div id="challengeCountdown">00:00:00</div>
    <div id="dailyProgressBarContainer">
      <div id="dailyProgressBar"></div>
    </div>
  </div>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const dailyGoal = 50;

    const plantBtn = document.getElementById('plantBtn');
    const nameInput = document.getElementById('nameInput');
    const counterEl = document.getElementById('counter');
    const leaderboardEl = document.getElementById('leaderboard');
    const treeEmoji = document.getElementById('treeEmoji');
    const myStats = document.getElementById('myStats');
    const progressBar = document.getElementById('progressBar');
    const challengeCountdown = document.getElementById('challengeCountdown');
    const dailyProgressBar = document.getElementById('dailyProgressBar');
    const factsEl = document.getElementById('facts');

    const facts = [
      "Trees help reduce air pollution and provide oxygen.",
      "One large tree can provide a day's supply of oxygen for four people.",
      "Planting trees helps combat climate change.",
      "Urban forests reduce energy use for air conditioning.",
      "Trees reduce stormwater runoff and prevent erosion.",
      "Forests are home to 80% of terrestrial species."
    ];

    function rotateFacts() {
      let index = 0;
      setInterval(() => {
        factsEl.textContent = "Did you know? ðŸŒ³ " + facts[index];
        index = (index + 1) % facts.length;
      }, 6000);
    }

    function getTodayKey() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    function animateTree() {
      treeEmoji.classList.add('tree-bounce');
      setTimeout(() => {
        treeEmoji.classList.remove('tree-bounce');
      }, 700);
    }

    function updateTotalCount(count) {
      counterEl.textContent = count;
      const percent = Math.min((count / dailyGoal) * 100, 100);
      progressBar.style.width = percent + '%';
      dailyProgressBar.style.width = percent + '%';
    }

    function updateLeaderboard(users) {
      leaderboardEl.innerHTML = '';
      const sorted = Object.entries(users)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      sorted.forEach(([name, count]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${count} tree${count !== 1 ? 's' : ''}`;
        leaderboardEl.appendChild(li);
      });
    }

    function updateMyStats(userName) {
      const todayKey = getTodayKey();
      database.ref(`users/${userName}/${todayKey}`).once('value').then(snapshot => {
        const count = snapshot.val() || 0;
        myStats.textContent = `You have planted ${count} tree${count !== 1 ? 's' : ''}.`;
      });
    }

    function incrementGlobalCount() {
      const todayKey = getTodayKey();
      const ref = database.ref(`treeCount/${todayKey}`);
      return ref.transaction(current => (current || 0) + 1);
    }

    function incrementUserCount(userName) {
      const todayKey = getTodayKey();
      const ref = database.ref(`users/${userName}/${todayKey}`);
      return ref.transaction(current => (current || 0) + 1);
    }

    function listenRealtime() {
      const todayKey = getTodayKey();

      database.ref(`treeCount/${todayKey}`).on('value', snap => {
        const count = snap.val() || 0;
        updateTotalCount(count);
      });

      database.ref('users').on('value', snap => {
        const allUsers = snap.val() || {};
        const counts = {};
        for (const user in allUsers) {
          counts[user] = allUsers[user][todayKey] || 0;
        }
        updateLeaderboard(counts);
      });
    }

    function startCountdown() {
      function update() {
        const now = new Date();
        const midnight = new Date(now);
        midnight.setHours(24, 0, 0, 0);
        const diff = midnight - now;

        const hrs = String(Math.floor(diff / (1000*60*60))).padStart(2, '0');
        const mins = String(Math.floor((diff % (1000*60*60)) / (1000*60))).padStart(2, '0');
        const secs = String(Math.floor((diff % (1000*60)) / 1000)).padStart(2, '0');

        challengeCountdown.textContent = `${hrs}:${mins}:${secs}`;

        if (diff < 1000) {
          dailyProgressBar.style.width = '0%';
        }
      }
      update();
      setInterval(update, 1000);
    }

    plantBtn.addEventListener('click', () => {
      const userName = nameInput.value.trim();
      if (!userName) {
        alert('Please enter your name.');
        return;
      }

      plantBtn.disabled = true;

      Promise.all([
        incrementGlobalCount(),
        incrementUserCount(userName)
      ]).then(() => {
        animateTree();
        updateMyStats(userName);
      }).catch(err => {
        alert('Error planting tree: ' + err.message);
      }).finally(() => {
        plantBtn.disabled = false;
      });
    });

    // On load
    listenRealtime();
    startCountdown();
    rotateFacts();
  </script>
</body>
</html>
