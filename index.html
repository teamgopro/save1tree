<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees</title>
  <style>
    /* --- Reset & base --- */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0fdf4;
      color: #065f46;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      min-height: 100vh;
    }
    h1 {
      font-size: 2.8rem;
      margin-bottom: 15px;
      font-weight: 900;
      color: #10b981;
      text-shadow: 0 1px 6px rgba(16,185,129,0.3);
    }
    /* --- Layout --- */
    #app-container {
      display: flex;
      width: 100%;
      max-width: 1100px;
      gap: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* --- Left side (main content) --- */
    #left-side {
      flex: 1 1 500px;
      background: #d1fae5;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.25);
      padding: 25px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #counter {
      font-size: 4rem;
      font-weight: 900;
      color: #047857;
      margin: 0;
      user-select: none;
    }
    #facts {
      margin: 20px 0 30px;
      font-style: italic;
      font-size: 1.15rem;
      max-width: 450px;
      text-align: center;
      color: #065f46cc;
      min-height: 48px;
      transition: opacity 0.8s ease;
    }
    form#plantForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 420px;
    }
    input[type="text"] {
      padding: 12px 14px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1.5px solid #a7f3d0;
      outline-offset: 2px;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus {
      border-color: #059669;
    }
    button#plantBtn {
      background: linear-gradient(45deg, #34d399, #059669);
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
      border: none;
      padding: 14px;
      border-radius: 14px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
      transition: background 0.3s ease;
    }
    button#plantBtn:hover {
      background: linear-gradient(45deg, #059669, #047857);
    }

    #treeEmoji {
      font-size: 5rem;
      margin: 30px 0 10px;
      user-select: none;
      cursor: default;
      animation: bounce 0.6s ease;
      animation-iteration-count: 1;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    /* --- Right side (leaderboard + dedications) --- */
    #right-side {
      flex: 1 1 350px;
      display: flex;
      flex-direction: column;
      gap: 35px;
    }

    /* Leaderboard */
    #leaderboard-container {
      background: #ffffffcc;
      backdrop-filter: saturate(180%) blur(20px);
      border-radius: 18px;
      box-shadow: 0 0 25px rgba(16, 185, 129, 0.3);
      padding: 25px 30px;
      max-height: 450px;
      overflow-y: auto;
    }
    #leaderboard-container h3 {
      margin: 0 0 18px 0;
      color: #059669;
      font-weight: 800;
      font-size: 1.8rem;
      user-select: none;
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #leaderboard li {
      background: #a7f3d0;
      padding: 12px 18px;
      border-radius: 14px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(5,150,105,0.25);
      user-select: none;
      transition: transform 0.3s ease;
      cursor: default;
    }
    #leaderboard li:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 14px rgba(5,150,105,0.4);
    }
    .medal {
      font-size: 1.6rem;
      user-select: none;
    }

    /* Dedications */
    #dedications-container {
      background: #ffffffbb;
      backdrop-filter: saturate(180%) blur(30px);
      border-radius: 18px;
      box-shadow: 0 0 25px rgba(16, 185, 129, 0.3);
      padding: 25px 30px;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    #dedications-container h3 {
      margin: 0 0 18px 0;
      color: #059669;
      font-weight: 800;
      font-size: 1.8rem;
      user-select: none;
    }
    #dedications {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #dedications li {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #d1fae5cc;
      color: #065f46dd;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.3;
      box-shadow: 0 2px 6px rgba(5,150,105,0.2);
      opacity: 0;
      animation: fadeInUp 0.7s forwards;
      user-select: none;
    }
    #dedications li .dedication-user {
      font-weight: 800;
      color: #047857;
      margin-bottom: 4px;
    }
    #dedications li .dedication-message {
      font-style: italic;
      color: #065f46cc;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 900px) {
      #app-container {
        flex-direction: column;
        align-items: center;
      }
      #right-side {
        width: 100%;
      }
      #left-side {
        width: 100%;
        max-width: 600px;
      }
    }

  </style>
</head>
<body>
  <h1>ðŸŒ³ TEKA Trees ðŸŒ³</h1>
  <div id="app-container">
    <!-- Left side -->
    <section id="left-side">
      <div id="counter">0</div>
      <div id="facts"></div>
      <form id="plantForm" autocomplete="off" spellcheck="false">
        <input
          type="text"
          id="nameInput"
          placeholder="Enter your name"
          required
          maxlength="25"
        />
        <input
          type="text"
          id="dedicationInput"
          placeholder="Dedication (optional)"
          maxlength="60"
        />
        <button type="submit" id="plantBtn" aria-label="Plant a Tree Button">
          ðŸŒ± Plant Tree
        </button>
      </form>
      <div id="treeEmoji">ðŸŒ³</div>
    </section>

    <!-- Right side -->
    <section id="right-side">
      <div id="leaderboard-container" aria-label="Leaderboard Section">
        <h3>Leaderboard</h3>
        <ul id="leaderboard"></ul>
      </div>

      <div id="dedications-container" aria-label="Dedications Section">
        <h3>Recent Dedications</h3>
        <ul id="dedications"></ul>
      </div>
    </section>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const counterEl = document.getElementById("counter");
    const factsEl = document.getElementById("facts");
    const treeEmoji = document.getElementById("treeEmoji");
    const leaderboardEl = document.getElementById("leaderboard");
    const dedicationsEl = document.getElementById("dedications");
    const plantForm = document.getElementById("plantForm");
    const nameInput = document.getElementById("nameInput");
    const dedicationInput = document.getElementById("dedicationInput");

    // Facts to rotate
    const facts = [
      "Trees absorb harmful gases and give us clean oxygen.",
      "One tree can remove up to 48 pounds of CO2 per year.",
      "Urban forests can reduce city temperatures by up to 10Â°F.",
      "Trees are home to more than 80% of land-based species.",
      "Planting trees can reduce stress and improve mood.",
      "Every minute, 23,000 acres of forest are lost worldwide.",
      "Trees help prevent soil erosion and improve water quality.",
      "The world's oldest tree is over 5,000 years old.",
      "Trees provide food, shelter, and medicine for millions of people.",
      "Reforestation can help combat climate change effectively."
    ];
    let factIndex = 0;

    // Animate tree bounce
    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 600);
    }

    // Show rotating facts
    function rotateFacts() {
      factsEl.style.opacity = 0;
      setTimeout(() => {
        factsEl.textContent = facts[factIndex];
        factsEl.style.opacity = 1;
        factIndex = (factIndex + 1) % facts.length;
      }, 700);
    }
    rotateFacts();
    setInterval(rotateFacts, 7000);

    // Get today's date string
    function getTodayKey() {
      return new Date().toISOString().split("T")[0];
    }

    // Medals for leaderboard
    const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];

    // Render leaderboard with emoji places
    function renderLeaderboard(data) {
      leaderboardEl.innerHTML = "";
      if (!data) {
        leaderboardEl.innerHTML = "<li>No data yet</li>";
        return;
      }
      // Map and sort
      const today = getTodayKey();
      const usersArray = Object.entries(data).map(([username, days]) => {
        return {
          username,
          count: days[today] || 0
        };
      });
      usersArray.sort((a, b) => b.count - a.count);

      usersArray.slice(0, 10).forEach((user, idx) => {
        const li = document.createElement("li");
        const medal = medals[idx] || "ðŸŒ²";
        li.innerHTML = `<span class="medal">${medal}</span> <span>${user.username}: <strong>${user.count} tree${user.count !== 1 ? 's' : ''}</strong></span>`;
        leaderboardEl.appendChild(li);
      });

      if (usersArray.length === 0) {
        leaderboardEl.innerHTML = "<li>No trees planted yet</li>";
      }
    }

    // Render last 5 dedications with fade in
    function renderDedications(data) {
      dedicationsEl.innerHTML = "";
      if (!data) return;
      // Get last 5 dedications across all dates
      const allDeds = [];
      Object.values(data).forEach(dateGroup => {
        Object.values(dateGroup).forEach(arr => {
          if (Array.isArray(arr)) {
            allDeds.push(...arr);
          } else if (typeof arr === "object") {
            Object.values(arr).forEach(subArr => {
              allDeds.push(...subArr);
            });
          }
        });
      });
      const lastFive = allDeds.slice(-5);
      if (lastFive.length === 0) {
        dedicationsEl.innerHTML = `<li>No dedications yet ðŸŒ¿</li>`;
        return;
      }
      lastFive.forEach((ded, i) => {
        if (!ded || !ded.user) return;
        const message = ded.message ? ded.message.trim() : "";
        const li = document.createElement("li");
        li.style.animationDelay = `${i * 0.3}s`;
        li.innerHTML = `<div class="dedication-user">ðŸ‘¤ ${ded.user}</div>`;
        if (message.length > 0) {
          li.innerHTML += `<div class="dedication-message">ðŸ’¬ "${message}"</div>`;
        }
        dedicationsEl.appendChild(li);
      });
    }

    // Update global tree count
    function updateCounter(count) {
      counterEl.textContent = count.toLocaleString();
    }

    // Fetch and render all data from Firebase
    function fetchData() {
      db.ref("/").once("value").then(snapshot => {
        const data = snapshot.val() || {};
        // Calculate total trees
        let totalTrees = 0;
        Object.values(data).forEach(dateGroup => {
          Object.values(dateGroup).forEach(userData => {
            if (typeof userData === "object") {
              Object.values(userData).forEach(val => {
                if (typeof val === "number") totalTrees += val;
                else if (Array.isArray(val)) totalTrees += val.length;
              });
            }
          });
        });
        updateCounter(totalTrees);

        renderLeaderboard(data);
        renderDedications(data);
      });
    }

    // Plant tree logic
    plantForm.addEventListener("submit", (e) => {
      e.preventDefault();

      let username = nameInput.value.trim();
      if (!username) {
        alert("Please enter your name to plant a tree ðŸŒ±");
        return;
      }
      if (username.length > 25) username = username.slice(0, 25);

      const dedication = dedicationInput.value.trim();
      const today = getTodayKey();

      // Update Firebase counts
      const userDayRef = db.ref(`${today}/${username}/count`);
      const userDedRef = db.ref(`${today}/${username}/dedications`);

      // Increase count by 1 and add dedication
      userDayRef.transaction((current) => (current || 0) + 1);

      if (dedication.length > 0) {
        userDedRef.push({
          user: username,
          message: dedication,
          timestamp: Date.now()
        });
      }

      // Reset inputs
      dedicationInput.value = "";

      // Animate tree
      animateTree();

      // Refresh data
      fetchData();
    });

    // Initial fetch and interval refresh
    fetchData();
    setInterval(fetchData, 8000);
  </script>
</body>
</html>
