<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TEKA Trees üå≥</title>
<style>
  /* --- PRELOAD SCREEN --- */
  #loading {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: var(--bg); display:flex; align-items:center; justify-content:center;
    z-index:9999; transition: opacity .5s ease-out, visibility .5s;
  }
  #loading.hide { opacity:0; visibility:hidden; }
  .spinner {
    border:5px solid var(--bar-bg); border-top:5px solid var(--accent);
    border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;
  }
  @keyframes spin { to {transform:rotate(360deg);} }

  /* --- THEMES --- */
  :root {
    --bg: #e8f5e9; --fg: #1b5e20; --accent: #43a047;
    --bar-bg: #c8e6c9; --bar-fill: linear-gradient(90deg, #43a047, #66bb6a);
    --card: #f9f9f9;
  }
  [data-theme="dark"] {
    --bg: #1a1a1a; --fg: #ddd; --accent: #66bb6a;
    --bar-bg: #2f3a2e; --card: #2a2a2a;
  }
  body {
    margin:0; background:var(--bg); color:var(--fg);
    font-family:'Segoe UI',sans-serif; display:flex;
    min-height:100vh; transition:background .3s,color .3s;
  }
  button { cursor:pointer; border:none; transition:.3s; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  /* --- LAYOUT --- */
  .container { display:flex; flex:1; gap:40px; padding:40px; }
  .main { flex:2; max-width:500px; }
  .sidebar { flex:1; max-width:300px; }

  /* --- HEADER --- */
  header { display:flex; justify-content:space-between; align-items:center; }
  header h1 { font-size:2.8rem; margin:0; }
  #darkToggle {
    padding:8px 12px; background:var(--accent); color:#fff; border-radius:8px;
  }

  /* --- COUNTER + PROGRESS --- */
  .counter { font-size:3rem; margin:10px 0; font-weight:700; }
  .goal-bar { background:var(--bar-bg); border-radius:15px; overflow:hidden; height:20px; }
  .goal-fill { height:100%; width:0; background:var(--bar-fill); transition:width .5s; }

  /* --- FORM --- */
  .form-group { margin:20px 0; display:flex; flex-direction:column; gap:12px; }
  input { padding:12px; border-radius:8px; border:1px solid var(--bar-bg); font-size:1rem; }
  #plantBtn, #clickBtn {
    background:var(--accent); color:#fff; padding:12px; border-radius:8px;
    font-weight:600;
  }
  #plantBtn:hover, #clickBtn:hover { background:#336633; }

  /* --- TREE ICON --- */
  .tree { text-align:center; font-size:3rem; margin:20px 0; }
  .pop { animation:pop 0.6s ease; }
  @keyframes pop { 50% {transform:scale(1.3);} }

  /* --- LEADERBOARD --- */
  ul#leaderboard { list-style:none; margin:20px 0; padding:0; border-radius:10px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  ul#leaderboard li {
    display:flex; justify-content:space-between; padding:12px 15px; background:var(--card);
    position:relative; transition:background .3s;
  }
  ul#leaderboard li:hover { background:var(--bar-bg); }
  ul#leaderboard li:nth-child(1)::before { content:"ü•á"; position:absolute; left:-30px; }
  ul#leaderboard li:nth-child(2)::before { content:"ü•à"; position:absolute; left:-30px; }
  ul#leaderboard li:nth-child(3)::before { content:"ü•â"; position:absolute; left:-30px; }

  /* --- DEDICATIONS --- */
  .chat { max-height:600px; overflow-y:auto; background:var(--card); border-radius:15px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  .chat h2 { margin-top:0; }
  .dedication {
    background:#fff; padding:12px 14px; margin-bottom:12px; border-radius:10px;
    box-shadow:0 2px 4px rgba(0,0,0,0.05); opacity:0; transform:translateY(20px);
    animation:dedIn 0.6s ease forwards;
    transition:transform .3s;
  }
  .dedication:hover { transform:translateX(8px); }
  @keyframes dedIn { to { opacity:1; transform:translateY(0);} }

  /* --- CLICK SUPPORT --- */
  .click-stats { margin:10px 0; font-weight:bold; }

  @media (max-width:900px) {
    .container { flex-direction:column; align-items:center; }
    .sidebar { width:100%; max-width:none; }
  }
</style>
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div id="loading"><div class="spinner"></div></div>

  <section class="container">
    <div class="main">
      <header>
        <h1>TEKA Trees üå≥</h1>
        <button id="darkToggle">Dark Mode</button>
      </header>

      <div class="counter" id="treeCount">0 Trees</div>
      <div class="goal-bar"><div class="goal-fill" id="goalFill"></div></div>

      <div class="form-group">
        <input type="text" id="username" placeholder="Your Name">
        <input type="text" id="dedication" placeholder="Dedication (optional)">
        <button id="plantBtn">üå± Plant a Tree</button>
      </div>

      <div class="click-stats">Clicks: <span id="clickCount">0</span> (100 clicks = +100 üå≥)</div>
      <button id="clickBtn">üî• Click to Support</button>

      <div class="tree" id="treeEmoji">üå≥</div>

      <h2>üèÜ Leaderboard</h2>
      <ul id="leaderboard"></ul>
    </div>

    <aside class="sidebar">
      <div class="chat">
        <h2>üåø Latest Dedications</h2>
        <div id="dedications"></div>
      </div>
    </aside>
  </section>

  <audio id="plantSound" src="https://freesound.org/data/previews/341/341695_5260872-lq.mp3"></audio>
  <audio id="cheerSound" src="https://freesound.org/data/previews/112/112203_2940892-lq.mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Initialization
    const firebaseConfig = {
      apiKey:"AIzaSyAP9...", authDomain:"save1tree-f116f.firebaseapp.com",
      databaseURL:"https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId:"save1tree-f116f", storageBucket:"...", messagingSenderId:"823144374779",
      appId:"1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const GOAL = 100_000_000;
    let clickCount = 0, lastPlantTimestamp = 0;

    const el = {
      treeCount: document.getElementById('treeCount'),
      goalFill: document.getElementById('goalFill'),
      leaderboard: document.getElementById('leaderboard'),
      dedications: document.getElementById('dedications'),
      treeEmoji: document.getElementById('treeEmoji'),
      username: document.getElementById('username'),
      dedication: document.getElementById('dedication'),
      plantBtn: document.getElementById('plantBtn'),
      clickBtn: document.getElementById('clickBtn'),
      clickCount: document.getElementById('clickCount'),
      darkToggle: document.getElementById('darkToggle'),
      plantSound: document.getElementById('plantSound'),
      cheerSound: document.getElementById('cheerSound'),
    };

    // Dark Mode
    function setTheme(dark) {
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
      localStorage.setItem('darkMode', dark);
      el.darkToggle.textContent = dark ? 'Light Mode' : 'Dark Mode';
    }
    el.darkToggle.onclick = ()=> setTheme(document.documentElement.getAttribute('data-theme')==='light');
    window.onload = ()=> {
      el.loading && el.loading.classList.add('hide');
      const dm = localStorage.getItem('darkMode')==='true';
      setTheme(dm);
    };

    function animateTree(){
      el.treeEmoji.classList.add('pop');
      setTimeout(()=> el.treeEmoji.classList.remove('pop'),600);
    }

    function playPlantSound(){ el.plantSound.play().catch(()=>{}); }
    function playCheer(){ el.cheerSound.play().catch(()=>{}); }

    function getTodayKey(){ return new Date().toISOString().split('T')[0]; }

    el.plantBtn.onclick = ()=> {
      const name = el.username.value.trim() || 'Anonymous';
      const msg = el.dedication.value.trim().substring(0,100);
      const now = Date.now();
      if (now - lastPlantTimestamp < 5000) return alert('‚è≥ 5s cooldown');
      lastPlantTimestamp = now;

      const today = getTodayKey();
      db.ref('treeCount').transaction(n=> (n||0)+1);
      db.ref(`users/${encodeURIComponent(name)}/${today}`).transaction(n=> (n||0)+1);
      if (msg) db.ref(`dedications/${today}`).push({ user:name, message:msg, time:now });

      animateTree(); playPlantSound();
    };

    el.clickBtn.onclick = ()=>{
      clickCount++;
      el.clickCount.textContent = clickCount;
      if (clickCount>=100){
        clickCount=0;
        el.clickCount.textContent='0';
        db.ref('treeCount').transaction(n=> (n||0)+100);
        animateTree(); playCheer();
      }
    };

    // Live Updates
    db.ref('treeCount').on('value',snapshot=>{
      const c = snapshot.val()||0;
      el.treeCount.textContent = c.toLocaleString()+' Trees';
      el.goalFill.style.width = Math.min((c/GOAL)*100,100)+'%';
      if (c >= GOAL && !localStorage.getItem('goalMet')) {
        localStorage.setItem('goalMet','yes'); playCheer();
      }
    });

    db.ref('users').on('value',snapshot=>{
      el.leaderboard.innerHTML='';
      const today = getTodayKey();
      let arr = [];
      snapshot.forEach(userSnap => {
        const name = userSnap.key;
        const count = userSnap.child(today).val()||0;
        arr.push([decodeURIComponent(name), count]);
      });
      arr.sort((a,b)=>b[1]-a[1]);
      arr.slice(0,10).forEach((u,i)=>{
        const li = document.createElement('li');
        li.innerHTML=`<span>${u[0]}</span><span>${u[1]} üå≥</span>`;
        el.leaderboard.appendChild(li);
      });
    });

    db.ref(`dedications/${getTodayKey()}`).limitToLast(5).on('child_added',snapshot=>{
      const d = snapshot.val();
      const div = document.createElement('div');
      div.className = 'dedication';
      div.innerHTML = `<strong>${d.user}</strong>: ${d.message}`;
      el.dedications.prepend(div);
      if (el.dedications.childElementCount>5) el.dedications.lastChild.remove();
    });
  </script>
</body>
</html>
