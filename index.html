<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees - Old Style</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #e0f7fa;
      color: #004d40;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1, h2 {
      font-weight: 700;
      color: #004d40;
    }
    #counter {
      font-size: 4rem;
      font-weight: 900;
      margin: 0.2em 0 0.5em;
    }
    #progressBar {
      height: 22px;
      background: linear-gradient(90deg, #00bfa5, #004d40);
      border-radius: 15px;
      width: 0%;
      margin: 0 auto 25px;
      max-width: 400px;
      box-shadow: 0 0 8px #00796b;
      transition: width 0.5s ease;
    }
    #dailyProgressBar {
      height: 22px;
      background: linear-gradient(90deg, #004d40, #00bfa5);
      border-radius: 15px;
      width: 0%;
      margin: 0 auto 10px;
      max-width: 400px;
      box-shadow: 0 0 8px #004d40;
      transition: width 0.5s ease;
    }
    form {
      margin: 15px auto 30px;
      max-width: 400px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      font-size: 1rem;
      border: 2px solid #004d40;
      border-radius: 8px;
      color: #004d40;
    }
    button {
      background: #00796b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #004d40;
    }
    button:disabled {
      background: #a5d6a7;
      cursor: not-allowed;
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      max-width: 400px;
      margin: 0 auto 40px;
      color: #004d40;
      font-weight: 600;
    }
    #leaderboard li {
      background: #b2dfdb;
      padding: 8px 12px;
      border-radius: 10px;
      margin-bottom: 6px;
      box-shadow: inset 0 0 4px #004d40aa;
    }
    #myStats {
      margin-bottom: 20px;
      font-weight: bold;
      color: #00796b;
    }
    #challengeCountdown {
      font-weight: bold;
      color: #00796b;
      margin-bottom: 20px;
    }
    #tree {
      font-size: 4rem;
      margin: 0 auto 20px;
      display: none;
      transition: transform 1s ease, opacity 1s ease;
    }
    #slowDownToggle {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

  <h1>TEKA Trees</h1>

  <div id="myStats">You have planted 0 trees.</div>

  <div id="counter">0</div>
  <div id="progressBar"></div>

  <form id="plantForm">
    <input
      type="text"
      id="dedicationInput"
      placeholder="Dedicate this tree (optional, max 50 chars)"
      maxlength="50"
      autocomplete="off"
    />
    <button type="submit" id="plantBtn">Plant Tree ðŸŒ³</button>
  </form>

  <button id="slowDownToggle">Slow Down Mode: OFF</button>

  <h2>Daily Challenge Progress</h2>
  <div id="dailyProgressBar"></div>
  <div>Time left: <span id="challengeCountdown">00:00:00</span></div>

  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>

  <div id="tree" aria-hidden="true">ðŸŒ³</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Elements
    const plantForm = document.getElementById("plantForm");
    const dedicationInput = document.getElementById("dedicationInput");
    const leaderboardEl = document.getElementById("leaderboard");
    const counterEl = document.getElementById("counter");
    const progressBar = document.getElementById("progressBar");
    const dailyProgressBar = document.getElementById("dailyProgressBar");
    const myStats = document.getElementById("myStats");
    const challengeCountdown = document.getElementById("challengeCountdown");
    const plantBtn = document.getElementById("plantBtn");
    const slowDownToggle = document.getElementById("slowDownToggle");
    const treeEmoji = document.getElementById("tree");

    // Constants
    const dailyGoal = 50;
    const slowDownInterval = 10000; // 10 seconds between plants in slow down mode

    // User ID fixed (no login)
    const userId = "anonymousUser";

    // Slow down mode state
    let slowDownMode = false;
    let lastPlantTime = 0;

    // Helper - get today's date key "YYYY-MM-DD"
    function getTodayKey() {
      const now = new Date();
      return now.toISOString().slice(0, 10);
    }

    // Animate tree emoji on plant
    function animateTree() {
      treeEmoji.style.display = "inline-block";
      treeEmoji.style.opacity = "1";
      treeEmoji.style.transform = "scale(1)";
      setTimeout(() => {
        treeEmoji.style.transition = "opacity 1s ease, transform 1s ease";
        treeEmoji.style.opacity = "0";
        treeEmoji.style.transform = "scale(2)";
        setTimeout(() => {
          treeEmoji.style.display = "none";
          treeEmoji.style.transition = "";
          treeEmoji.style.transform = "";
        }, 1000);
      }, 200);
    }

    // Update leaderboard and stats display
    async function updateLeaderboard() {
      const snapshot = await db.ref("users").once("value");
      const usersData = snapshot.val() || {};

      let entries = [];
      for (const uid in usersData) {
        let total = 0;
        for (const key in usersData[uid]) {
          if (key !== "username") {
            const val = usersData[uid][key];
            if (typeof val === "number") total += val;
          }
        }
        entries.push({ uid, count: total });
      }

      entries.sort((a, b) => b.count - a.count);

      leaderboardEl.innerHTML = "";
      entries.slice(0, 10).forEach(entry => {
        const name = entry.uid === userId ? "You" : entry.uid.substring(0, 6);
        const li = document.createElement("li");
        li.textContent = `${name}: ${entry.count} tree${entry.count !== 1 ? "s" : ""}`;
        leaderboardEl.appendChild(li);
      });

      const totalTrees = entries.reduce((sum, e) => sum + e.count, 0);
      counterEl.textContent = totalTrees.toLocaleString();

      const progress = Math.min(totalTrees / 1000, 1);
      progressBar.style.width = (progress * 100) + "%";

      // Update myStats
      const myData = usersData[userId] || {};
      let myCount = 0;
      for (const key in myData) {
        if (key !== "username" && typeof myData[key] === "number") myCount += myData[key];
      }
      myStats.textContent = `You have planted ${myCount} tree${myCount !== 1 ? "s" : ""}.`;

      updateDailyChallenge(usersData);
    }

    // Update daily challenge bar and countdown
    function updateDailyChallenge(usersData) {
      const today = getTodayKey();
      let dailyTotal = 0;

      if (usersData) {
        for (const user in usersData) {
          if (usersData[user][today]) dailyTotal += usersData[user][today];
        }
      }

      const progress = Math.min(dailyTotal / dailyGoal, 1);
      dailyProgressBar.style.width = (progress * 100) + "%";

      // Countdown to midnight UTC
      const now = new Date();
      const tomorrow = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1));
      const diff = tomorrow.getTime() - now.getTime();

      const hrs = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      const pad = n => n.toString().padStart(2, "0");
      challengeCountdown.textContent = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
    }

    // Handle slow down toggle button
    slowDownToggle.addEventListener("click", () => {
      slowDownMode = !slowDownMode;
      slowDownToggle.textContent = `Slow Down Mode: ${slowDownMode ? "ON" : "OFF"}`;
      if (!slowDownMode) {
        plantBtn.disabled = false; // re-enable button immediately if turning off slow mode
      }
    });

    plantForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const now = Date.now();

      if (slowDownMode && now - lastPlantTime < slowDownInterval) {
        const waitSeconds = Math.ceil((slowDownInterval - (now - lastPlantTime)) / 1000);
        alert(`Slow Down Mode is ON! Please wait ${waitSeconds} more second${waitSeconds !== 1 ? "s" : ""} before planting again.`);
        return;
      }

      const dedication = dedicationInput.value.trim().slice(0, 50);
      const today = getTodayKey();

      plantBtn.disabled = true;

      // Update count for user for today
      const userDayRef = db.ref(`users/${userId}/${today}`);
      const snapshot = await userDayRef.once("value");
      const currentCount = snapshot.val() || 0;
      await userDayRef.set(currentCount + 1);

      // Store dedication if provided
      if (dedication) {
        const dedicationRef = db.ref(`dedications/${userId}/${Date.now()}`);
        await dedicationRef.set(dedication);
      }

      dedicationInput.value = "";
      lastPlantTime = now;

      animateTree();
      await updateLeaderboard();

      // Re-enable button after delay if slowDownMode ON, else immediately
      if (slowDownMode) {
        setTimeout(() => {
          plantBtn.disabled = false;
        }, slowDownInterval);
      } else {
        plantBtn.disabled = false;
      }
    });

    // Initial calls
    updateLeaderboard();

    // Periodically update leaderboard and countdowns
    setInterval(updateLeaderboard, 60000);
    setInterval(() => {
      updateDailyChallenge(null);
    }, 1000);

  </script>

</body>
</html>
