<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees ‚Äì Global Goal Edition</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      padding: 20px;
      gap: 30px;
      font-family: 'Inter', sans-serif;
      background: #e6f4ea;
      color: #1e3a2f;
      overflow: hidden;
    }
    main {
      flex: 1;
      max-width: 480px;
      background: white;
      border-radius: 16px;
      padding: 30px 25px 40px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }
    h1 { font-weight: 600; font-size: 2.5rem; color: #065f46; margin-bottom: 15px; user-select: none; }
    #globalGoal {
      width: 100%;
      margin-bottom: 25px;
      user-select: none;
    }
    #globalGoalLabel {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #047857;
      margin-bottom: 6px;
    }
    #goalText {
      font-weight: 400;
      font-size: 0.9rem;
      color: #065f46cc;
    }
    #progressBar {
      width: 100%;
      height: 18px;
      background: #d1fae5;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgb(5 150 105 / 0.2);
    }
    #progressFill {
      height: 100%;
      background: linear-gradient(90deg, #059669, #10b981);
      width: 0%;
      border-radius: 14px;
      transition: width 1.2s ease;
    }
    #counter {
      font-size: 3.5rem;
      font-weight: 700;
      color: #047857;
      margin-bottom: 8px;
      user-select: none;
    }
    #facts {
      font-style: italic;
      text-align: center;
      max-width: 400px;
      margin-bottom: 30px;
      min-height: 48px;
      color: #065f46dd;
      user-select: none;
    }
    form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }
    input[type="text"] {
      padding: 14px 16px;
      border-radius: 12px;
      border: 1.5px solid #a7f3d0;
      font-size: 1rem;
      font-weight: 500;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus { border-color: #059669; background: #f0fdf4; }
    #nameInput.error { border-color: #ef4444; background: #fee2e2; }
    #nameError {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: -8px;
      margin-bottom: 8px;
      font-weight: 600;
      display: none;
    }
    button {
      padding: 14px 0;
      border: none;
      border-radius: 14px;
      background: #10b981;
      font-weight: 700;
      font-size: 1.15rem;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) { background: #059669; }
    button:disabled {
      background: #a7f3d0;
      cursor: not-allowed;
    }
    #treeEmoji {
      font-size: 4.5rem;
      margin: 25px 0 15px;
      user-select: none;
      transition: transform 0.5s ease;
    }
    .tree-bounce { animation: bounce 0.5s ease; }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    h2 { margin-top: 20px; color: #065f46; font-weight: 600; font-size: 1.7rem; user-select: none; }
    ul#leaderboard {
      list-style: none;
      padding: 0;
      width: 100%;
      margin-bottom: 25px;
    }
    ul#leaderboard li {
      background: #d1fae5;
      border-radius: 14px;
      margin-bottom: 10px;
      padding: 14px 18px;
      font-weight: 600;
      font-size: 1.1rem;
      color: #065f46;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: 0 2px 5px rgb(5 150 105 / 0.15);
    }
    ul#leaderboard li .medal { font-size: 1.6rem; }
    ul#leaderboard li:nth-child(1) { background: #fff9db; color: #b47b00; }
    ul#leaderboard li:nth-child(2) { background: #f0f7ff; color: #2563eb; }
    ul#leaderboard li:nth-child(3) { background: #fef0f0; color: #dc2626; }
    #rightPanel {
      width: 380px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }
    #dedicationsBox {
      flex: 1;
      background: rgba(255 255 255 / 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 25px rgb(0 0 0 / 0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #dedicationsBox h2 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 600;
      color: #065f46;
      user-select: none;
    }
    #dedicationsList {
      list-style: none;
      padding: 0;
      margin: 16px 0 0 0;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #dedicationsList li {
      background: rgba(255 255 255 / 0.45);
      border-radius: 14px;
      padding: 14px 18px;
      font-size: 1rem;
      color: #065f46dd;
      font-weight: 500;
      opacity: 0;
      animation: fadeIn 1s forwards;
      box-shadow: 0 2px 10px rgb(5 150 105 / 0.08);
    }
    #dedicationsList li span.user {
      font-weight: 700;
      color: #047857;
      margin-right: 8px;
      user-select: text;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <main>
    <h1>TEKA Trees</h1>
    <section id="globalGoal">
      <div id="globalGoalLabel">
        <span>üåç Global Goal Progress</span>
        <span id="goalText">0 / 100,000,000 trees</span>
      </div>
      <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100000000" aria-valuenow="0">
        <div id="progressFill"></div>
      </div>
    </section>
    <div id="counter">0</div>
    <div id="facts"></div>
    <form id="plantForm">
      <input type="text" id="nameInput" placeholder="Enter your name" />
      <div id="nameError">Please enter your name before planting.</div>
      <input type="text" id="dedicationInput" placeholder="Dedication (optional)" />
      <button type="submit" id="plantBtn">üå± Plant Tree</button>
    </form>
    <div id="treeEmoji">üå≥</div>
    <h2>Leaderboard</h2>
    <ul id="leaderboard"></ul>
  </main>
  <section id="rightPanel">
    <div id="dedicationsBox">
      <h2>Recent Dedications</h2>
      <ul id="dedicationsList"></ul>
    </div>
  </section>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const GLOBAL_GOAL = 100_000_000;
    const nameInput = document.getElementById("nameInput");
    const nameError = document.getElementById("nameError");
    const dedicationInput = document.getElementById("dedicationInput");
    const counterEl = document.getElementById("counter");
    const treeEmoji = document.getElementById("treeEmoji");
    const leaderboardEl = document.getElementById("leaderboard");
    const dedicationsList = document.getElementById("dedicationsList");
    const goalText = document.getElementById("goalText");
    const progressFill = document.getElementById("progressFill");
    const progressBar = document.getElementById("progressBar");

    let factIndex = 0;
    const facts = [
      "Trees absorb harmful gases and give us clean oxygen.",
      "One tree can remove up to 48 pounds of CO‚ÇÇ annually.",
      "Urban forests can cool cities by up to 10¬∞F.",
      "Trees host over 80% of land species.",
      "Planting trees boosts mood & reduces stress."
    ];

    const userCooldowns = {};

    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 500);
    }

    function rotateFacts() {
      document.getElementById("facts").textContent = facts[factIndex++];
      if (factIndex >= facts.length) factIndex = 0;
    }
    rotateFacts();
    setInterval(rotateFacts, 7000);

    function getTodayKey() {
      return new Date().toISOString().split("T")[0];
    }

    function validateName() {
      if (nameInput.value.trim() === "") {
        nameInput.classList.add("error");
        nameError.style.display = "block";
        return false;
      } else {
        nameInput.classList.remove("error");
        nameError.style.display = "none";
        return true;
      }
    }

    function updateLeaderboard(users) {
      leaderboardEl.innerHTML = "";
      const today = getTodayKey();
      const arr = Object.entries(users).map(([u, dates]) => [u, dates[today] || 0]);
      arr.sort((a, b) => b[1] - a[1]).slice(0,10).forEach((item, i) => {
        const [u, c] = item;
        if (c === 0) return;
        const li = document.createElement("li");
        const medals = ["ü•á","ü•à","ü•â"];
        const m = medals[i] || "";
        li.innerHTML = `<span class="medal">${m}</span>${u}: ${c} tree${c>1?'s':''}`;
        leaderboardEl.appendChild(li);
      });
    }

    function updateDedications(arr) {
      dedicationsList.innerHTML = "";
      const last = arr.slice(-5);
      last.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="user">${escapeHTML(item.user)}:</span>${escapeHTML(item.message)}`;
        dedicationsList.appendChild(li);
      });
    }

    function escapeHTML(s) {
      return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }

    function updateGlobalProgress(total) {
      const pct = Math.min(total / GLOBAL_GOAL * 100, 100).toFixed(3);
      progressFill.style.width = pct + '%';
      goalText.textContent = `${total.toLocaleString()} / ${GLOBAL_GOAL.toLocaleString()} trees`;
      progressBar.setAttribute("aria-valuenow", total);
    }

    function fetchGlobalTotal() {
      db.ref("treeCount").once("value", snap => {
        const data = snap.val() || {};
        let sum = Object.values(data).reduce((s,n) => s + (n || 0), 0);
        updateGlobalProgress(sum);
      });
    }

    document.getElementById("plantForm").addEventListener("submit", e => {
      e.preventDefault();
      if (!validateName()) return;

      const name = nameInput.value.trim();
      const msg = dedicationInput.value.trim();
      const now = Date.now();
      if (userCooldowns[name] && now - userCooldowns[name] < 5000) {
        alert("Please wait 5 seconds before planting again.");
        return;
      }
      userCooldowns[name] = now;

      const day = getTodayKey();
      db.ref("treeCount/" + day).transaction(n => (n||0)+1);
      db.ref("users/" + name + "/" + day).transaction(n => (n||0)+1);
      if (msg) db.ref(`dedications/${day}`).push({ user: name, message: msg });

      animateTree();
      dedicationInput.value = "";

      fetchGlobalTotal();
    });

    db.ref("users").on("value", snap => updateLeaderboard(snap.val() || {}));
    db.ref(`treeCount/${getTodayKey()}`).on("value", snap => counterEl.textContent = snap.val() || 0);
    db.ref(`dedications/${getTodayKey()}`).on("value", snap => {
      const v = snap.val() || {};
      const arr = Object.values(v);
      updateDedications(arr);
    });

    fetchGlobalTotal();
  </script>
</body>
</html>
