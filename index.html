<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEKA Trees - Old Style</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #e0f7fa;
      color: #004d40;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      font-weight: 700;
      color: #004d40;
    }
    #counter {
      font-size: 4rem;
      text-align: center;
      font-weight: 900;
    }
    #facts {
      text-align: center;
      font-style: italic;
      margin: 10px auto 25px;
      max-width: 500px;
      color: #00695c;
    }
    #progressBarContainer, #dailyProgressBarContainer {
      background: #b2dfdb;
      border-radius: 15px;
      margin: 0 auto 20px;
      box-shadow: inset 0 0 6px #004d40aa;
      width: 80%;
      max-width: 400px;
    }
    #progressBar, #dailyProgressBar {
      height: 22px;
      width: 0;
      border-radius: 15px;
      transition: width 0.4s ease;
      box-shadow: 0 0 8px #00796b;
    }
    #progressBar {
      background: linear-gradient(90deg, #00bfa5, #004d40);
    }
    #dailyProgressBar {
      background: linear-gradient(90deg, #004d40, #00bfa5);
    }
    #plantForm {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 400px;
      margin: auto;
    }
    #nameInput, #dedicationInput, #plantBtn {
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
      border: 2px solid #004d40;
      color: #004d40;
    }
    #nameInput, #dedicationInput {
      flex-grow: 1;
      min-width: 120px;
    }
    #plantBtn {
      background: #00796b;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
      min-width: 120px;
    }
    #treeEmoji {
      text-align: center;
      font-size: 3.5rem;
    }
    .tree-bounce {
      animation: bounce 0.7s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    #leaderboard {
      list-style: none;
      padding: 0;
      max-width: 400px;
      margin: auto 0 10px;
    }
    #leaderboard li {
      background: #b2dfdb;
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    #myStats, #challengeCountdown {
      text-align: center;
      font-weight: bold;
      color: #00796b;
      margin-bottom: 20px;
    }
    #dedicationsContainer {
      max-width: 400px;
      margin: 20px auto;
      padding: 10px;
      background: #b2dfdb;
      border-radius: 12px;
      box-shadow: inset 0 0 8px #004d40aa;
      color: #004d40;
    }
    #dedicationsContainer h2 {
      margin-top: 0;
    }
    #dedicationsList {
      max-height: 150px;
      overflow-y: auto;
      padding-left: 15px;
    }
    #dedicationsList li {
      margin-bottom: 6px;
      font-style: italic;
      border-bottom: 1px solid #004d4055;
      padding-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>TEKA Trees</h1>
  <div id="counter">0</div>
  <div id="facts"></div>
  <div id="progressBarContainer"><div id="progressBar"></div></div>
  
  <form id="plantForm">
    <input type="text" id="nameInput" placeholder="Enter your name" required />
    <input
      type="text"
      id="dedicationInput"
      placeholder="Add a dedication (optional)"
      maxlength="100"
      aria-label="Tree dedication message"
    />
    <button type="submit" id="plantBtn">Plant a Tree ðŸŒ³</button>
  </form>

  <div id="treeEmoji">ðŸŒ³</div>
  <div id="myStats">You have planted 0 trees.</div>
  
  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>

  <div id="dedicationsContainer">
    <h2>Recent Tree Dedications</h2>
    <ul id="dedicationsList"></ul>
  </div>

  <div id="dailyChallenge">
    <strong>Daily Goal: Plant 50 Trees</strong>
    <div id="challengeCountdown">00:00:00</div>
    <div id="dailyProgressBarContainer"><div id="dailyProgressBar"></div></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.appspot.com",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const dailyGoal = 50;

    const counterEl = document.getElementById("counter");
    const treeEmoji = document.getElementById("treeEmoji");
    const myStats = document.getElementById("myStats");
    const leaderboardEl = document.getElementById("leaderboard");
    const progressBar = document.getElementById("progressBar");
    const dailyProgressBar = document.getElementById("dailyProgressBar");
    const dedicationsList = document.getElementById("dedicationsList");

    function getTodayKey() {
      return new Date().toISOString().split('T')[0];
    }

    function animateTree() {
      treeEmoji.classList.add("tree-bounce");
      setTimeout(() => treeEmoji.classList.remove("tree-bounce"), 700);
    }

    function updateStats(name) {
      const key = getTodayKey();
      db.ref(`users/${name}/${key}`).once("value").then(snapshot => {
        const count = snapshot.val() || 0;
        myStats.textContent = `You have planted ${count} tree${count !== 1 ? 's' : ''}.`;
      });
    }

    function updateCountDisplay(count) {
      counterEl.textContent = count;
      const percent = Math.min((count / dailyGoal) * 100, 100);
      progressBar.style.width = percent + "%";
      dailyProgressBar.style.width = percent + "%";
    }

    function updateLeaderboard(users) {
      leaderboardEl.innerHTML = "";
      const today = getTodayKey();
      const entries = Object.entries(users).map(([user, days]) => [user, days[today] || 0]);
      entries.sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([user, count]) => {
        const li = document.createElement("li");
        li.textContent = `${user}: ${count} tree${count !== 1 ? 's' : ''}`;
        leaderboardEl.appendChild(li);
      });
    }

    function startCountdown() {
      function update() {
        const now = new Date();
        const midnight = new Date(now);
        midnight.setHours(24, 0, 0, 0);
        const diff = midnight - now;
        const hrs = String(Math.floor(diff / (1000*60*60))).padStart(2, '0');
        const mins = String(Math.floor((diff % (1000*60*60)) / (1000*60))).padStart(2, '0');
        const secs = String(Math.floor((diff % (1000*60)) / 1000)).padStart(2, '0');
        document.getElementById("challengeCountdown").textContent = `${hrs}:${mins}:${secs}`;
      }
      update();
      setInterval(update, 1000);
    }

    function listenRealtime() {
      const today = getTodayKey();
      db.ref(`treeCount/${today}`).on("value", snap => {
        updateCountDisplay(snap.val() || 0);
      });
      db.ref("users").on("value", snap => {
        updateLeaderboard(snap.val() || {});
      });

      // Listen for latest dedications (limit 10)
      db.ref(`dedications/${today}`).limitToLast(10).on("value", snap => {
        const data = snap.val();
        dedicationsList.innerHTML = "";
        if (!data) {
          dedicationsList.innerHTML = "<li>No dedications yet. Be the first!</li>";
          return;
        }
        // Sort dedications by timestamp descending
        const dedicationsArr = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
        dedicationsArr.forEach(ded => {
          const li = document.createElement("li");
          li.textContent = `${ded.user}: "${ded.message}"`;
          dedicationsList.appendChild(li);
        });
      });
    }

    document.getElementById("plantForm").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("nameInput").value.trim();
      const dedication = document.getElementById("dedicationInput").value.trim();
      if (!name) return alert("Please enter your name.");
      const today = getTodayKey();

      // Increment global and user counts
      db.ref(`treeCount/${today}`).transaction(n => (n || 0) + 1);
      db.ref(`users/${name}/${today}`).transaction(n => (n || 0) + 1);

      // Save dedication if given
      if (dedication) {
        const dedicationRef = db.ref(`dedications/${today}`).push();
        dedicationRef.set({
          user: name,
          message: dedication,
          timestamp: Date.now()
        });
      }

      animateTree();
      updateStats(name);

      if (dedication) {
        alert(`Thank you for your dedication:\n"${dedication}"`);
        document.getElementById("dedicationInput").value = "";
      }
    });

    const facts = [
      "Did you know? ðŸŒ³ Trees help reduce air pollution and provide oxygen for us to breathe.",
      "One large tree can supply oxygen for four people in a day.",
      "Trees absorb carbon dioxide, helping to fight climate change.",
      "Urban forests can cool cities by up to 10Â°F.",
      "Trees provide habitat for over 80% of the worldâ€™s terrestrial species."
    ];
    let factIndex = 0;
    function rotateFacts() {
      document.getElementById("facts").textContent = facts[factIndex];
      factIndex = (factIndex + 1) % facts.length;
    }
    rotateFacts();
    setInterval(rotateFacts, 7000);

    // Initialize
    listenRealtime();
    startCountdown();
  </script>
</body>
</html>
