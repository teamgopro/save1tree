<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TEKA — 3D Supercar Configurator</title>
  <meta name="description" content="TEKA Supercars — interactive 3D configurator with Firebase cloud saves." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230b1020'/><text x='50' y='58' font-size='48' text-anchor='middle' fill='%23fff' font-family='Verdana'>T</text></svg>">
  <style>
    /* ... (CSS remains the same as previous version) ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- ... (HTML remains the same as previous version) ... -->
  </div>

  <!-- Three.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ----------------- Firebase Config -----------------
    const firebaseConfig = {
      apiKey: "AIzaSyAP9sPhuV5aczilZipv6FQJ9aMoBOBhXXQ",
      authDomain: "save1tree-f116f.firebaseapp.com",
      databaseURL: "https://save1tree-f116f-default-rtdb.firebaseio.com",
      projectId: "save1tree-f116f",
      storageBucket: "save1tree-f116f.firebasestorage.app",
      messagingSenderId: "823144374779",
      appId: "1:823144374779:web:54a54f23cef8638dea6b5e"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let firebaseConfigured = true;

    // ----------------- 3D scene code -----------------
    const canvas = document.getElementById('threeCanvas');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
    renderer.outputEncoding = THREE.sRGBEncoding;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x071022);

    const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 2000);
    camera.position.set(0, 2.4, 6);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.12; controls.minDistance = 2; controls.maxDistance = 20; controls.maxPolarAngle = Math.PI/2.1;

    window.addEventListener('resize', ()=>{ const w=canvas.clientWidth,h=canvas.clientHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); });

    // lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x080820, 0.6); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); scene.add(dir);

    // ground
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({color:0x06080a,metalness:0.2,roughness:0.7})); ground.rotation.x = -Math.PI/2; ground.position.y = -0.7; scene.add(ground);

    // stylized car (body, roof, wheels)
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(3.6,0.6,1.6), new THREE.MeshStandardMaterial({color:0xff4b4b, metalness:0.3, roughness:0.2})); body.position.y=0.3; car.add(body);
    const roof = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.45,1.4), new THREE.MeshStandardMaterial({color:0x09131a})); roof.position.y=0.85; car.add(roof);
    const wheels = new THREE.Group();
    const wheelGeom = new THREE.CylinderGeometry(0.34,0.34,0.4,32); wheelGeom.rotateZ(Math.PI/2);
    [[-1.2,-0.3,0.95],[1.2,-0.3,0.95],[-1.2,-0.3,-0.95],[1.2,-0.3,-0.95]].forEach(p=>{ const w=new THREE.Mesh(wheelGeom,new THREE.MeshStandardMaterial({color:0x0b0b0b})); w.position.set(p[0],p[1],p[2]); wheels.add(w); }); car.add(wheels);
    scene.add(car);

    // animation loop
    function animate(t){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); } requestAnimationFrame(animate);

    // ----------------- UI state -----------------
    const selected = { color:'#ff4b4b', wheels:'std', interior:'black', mode:'comfort', model:{id:'tekax'} };

    // ----------------- Toast helper -----------------
    function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.innerText=msg; document.body.appendChild(el); setTimeout(()=>{el.style.transition='opacity .4s'; el.style.opacity='0'; setTimeout(()=>el.remove(),400);},1400); }

    // ----------------- Color options -----------------
    const colors=['#ff4b4b','#0b0b0b','#ffffff','#0ea5ff','#0ea5a4','#ffd166'];
    const colorsRoot = document.getElementById('colors');
    colors.forEach(c=>{ const el=document.createElement('div'); el.className='sw'; el.style.background=c; el.onclick=()=>{ car.children[0].material.color.set(c); selected.color=c; toast('Color set'); }; colorsRoot.appendChild(el); });

    // ----------------- Wheels options -----------------
    document.querySelectorAll('[data-wheel]').forEach(btn=>{ btn.addEventListener('click',()=>{ const w=btn.getAttribute('data-wheel'); selected.wheels=w; toast('Wheels: '+w); }); });

    // ----------------- Admin Panel -----------------
    document.getElementById('openAdmin').addEventListener('click', async ()=>{
      const pwd=prompt('Admin password'); if(pwd!=='tekaadmin') return alert('Wrong password');
      try{
        const snapshot = await db.collection('teka_submissions').get();
        const w = window.open('','_blank','width=900,height=700');
        w.document.write('<html><head><title>Admin</title><meta charset="utf-8"></head><body>');
        w.document.write('<h2>Cloud Submissions</h2>');
        snapshot.forEach(doc=>{ w.document.write('<pre>'+JSON.stringify(doc.data(),null,2)+'</pre>'); });
        w.document.write('</body></html>'); w.document.close();
      } catch(e){ console.error(e); toast('Failed to load submissions'); }
    });

    // ----------------- Save to Cloud -----------------
    document.getElementById('saveCloud').addEventListener('click', async ()=>{
      try{
        await db.collection('teka_submissions').add({type:'config',payload:selected,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
        toast('Saved to Cloud!');
      } catch(e){ console.error(e); toast('Cloud save failed'); }
    });

    // ----------------- Other UI events like reset, export, share (same as previous) -----------------
  </script>
</body>
</html>
